<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.forTicket.schedule.dao.ScheduleDAO">
	<resultMap id="scheduleResult" type="scheduleVO">
		<result property="s_no" column="s_no" />
		<result property="goods_id" column="goods_id" />
		<result property="theater_id" column="theater_id" />
		<result property="s_dateTime" column="s_date" />
		<result property="seats" column="seats" />
		<result property="goods_name" column="goods_name" />
		<result property="theater_name" column="theater_name"/>
		<result property="reg_id" column="reg_id"/>
	</resultMap>
	
	<select id="selectSchedule" resultType="scheduleVO" parameterType="java.util.Map">
		SELECT s.s_no, s.goods_id, s.theater_id, date_format(s.s_date,'%Y-%m-%d %H:%i') AS s_date, s.seats, s.reg_id, g.goods_name FROM schedule s, goods g
		WHERE s.goods_id = g.goods_id AND (theater_id=#{theater_id} AND date_format(s_date,'%Y-%m-%d')=#{s_date})
	</select>
	
	<select id="selectSchedule_order" resultType="scheduleVO" parameterType="java.util.Map">
		SELECT s.s_no, s.goods_id, s.theater_id, date_format(s.s_date,'%Y-%m-%d %H:%i') AS s_date, s.seats, g.goods_name FROM schedule s, goods g
		WHERE s.goods_id = g.goods_id AND date_format(s_date,'%Y-%m-%d')=#{s_date} order by s_date asc
	</select>
	
	<select id="scheduleInfo" resultType="scheduleVO" parameterType="java.util.Map">
		SELECT date_format(s.s_date,'%Y-%m-%d %H:%i') AS s_date, seats FROM schedule
		WHERE goods_id = #{goods_id} AND date_format(s_date,'%Y-%m-%d')=#{s_date}
	</select>
	
	<select id="selectScheduleByGoods" resultMap="scheduleResult" parameterType="java.util.Map">
		SELECT s.s_no, s.goods_id, s.theater_id, date_format(s.s_date,'%Y-%m-%d %H:%i') AS s_date, s.seats, s.reg_id, g.goods_name, t.theater_name FROM schedule s, goods g, theater t 
		where s.goods_id=#{goods_id} and g.goods_id=#{goods_id} and t.theater_id=#{theater_id} order by goods_id, s_date desc
	</select>
	
	<select id="selectAllSchedule" resultMap="scheduleResult">
		SELECT s.s_no, s.goods_id, s.theater_id, date_format(s.s_date,'%Y-%m-%d %H:%i') AS s_date, s.seats, s.reg_id, g.goods_name, t.theater_name FROM schedule s, goods g, theater t 
		where s.goods_id=g.goods_id and t.theater_name=g.goods_place order by goods_id, s_date desc
	</select>
	
	<insert id="insertSchedule" parameterType="java.util.Map">
		INSERT INTO schedule(goods_id, theater_id, s_date, seats, reg_id)
		VALUES(#{goods_id}, #{theater_id}, date_format(#{s_date},'%Y-%m-%d %H:%i'), #{seats}, #{reg_id})
	</insert>
	
	<delete id="deleteSchedule" parameterType="int">
		DELETE FROM schedule WHERE s_no=#{s_no}
	</delete>
	
	<update id="newOrder" parameterType="java.util.Map">
		UPDATE schedule
		SET seats=seats-#{seats} WHERE s_no=#{s_no}
	</update>
	
	<update id="cancelOrder" parameterType="java.util.Map">
		UPDATE schedule
		SET seats=seats+#{seats} WHERE s_no=#{s_no}
	</update>
</mapper>